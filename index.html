<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Carta para alma</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Fuente moderna y común (Inter) con fallbacks de sistema -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* =========================
           Escalado responsivo global
           ========================= */
        :root{
            /* Ancho base del sobre: escala con la ventana y limita en desktop */
            --W: min(92vw, 640px);

            /* Proporciones derivadas del diseño original 600x420 */
            --H: calc(var(--W) * 0.7);          /* 420/600 = 0.7 */
            --carta-w: calc(var(--W) * 0.9833); /* 590/600 ≈ 0.9833 */
            --carta-h: calc(var(--W) * 0.6667); /* 400/600 ≈ 0.6667 */

            /* Triángulos (bordes) según proporciones originales */
            --tri-half: calc(var(--W) / 2);      /* 300 en base 600 */
            --tri-top:  calc(var(--W) * 0.433);  /* 260/600 ≈ 0.433 */
            --tri-side: calc(var(--W) * 0.35);   /* 210/600 ≈ 0.35 */

            /* Desplazamientos animaciones escalados (antes 900 y 750) */
            --up-shift:   calc(var(--W) * -1.5);  /* -900/600 = -1.5 */
            --down-shift: calc(var(--W) * 1.25);  /*  750/600 =  1.25 */

            /* Separación superior del escenario (antes 150px fijo) */
            --stage-top: clamp(16px, 10vh, 150px);
        }

        /* --- Estilos base --- */
        * { box-sizing: border-box; margin:0; padding:0; }
        html,body { height:100%; }
        body {
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffc0cb;
            -webkit-font-smoothing:antialiased;
            overflow: hidden;
        }
        ::selection { background:#ffb3ba; color:#fff; }
        ::-moz-selection { background:#ffb3ba; color:#fff; }

        /* --- Perspectiva / Contenedor 3D --- */
        #perspectiva{
            position:absolute;
            top: var(--stage-top);
            left:50%;
            transform:translateX(-50%);
            perspective:800px;
            z-index:2;
            width: var(--W);
        }
        #contenedor{
            width: var(--W);
            height: var(--H);
            border-radius:10px;
            transform-style:preserve-3d;
            position:relative;
        }

        .cara{
            position:absolute; top:0; left:0;
            width:100%; height:100%;
            backface-visibility:hidden;
        }
        .cara h1{
            margin-top: calc(var(--H) * 0.38); /* equivalente proporcional a ~160px cuando W=600 */
            text-align:center;
            cursor:pointer;
            user-select:none;
            color:#ffffff;
            font-size: clamp(1rem, 3.5vw, 1.8em);
            text-shadow:0 1px 1px rgba(255,255,255,0.9);
        }

        .frontal{
            z-index:20;
            border-radius:10px;
            background:#bbd8c0;
            box-shadow:0 4px 10px rgba(0,0,0,0.1);
        }
        .trasera{
            transform:rotateY(-180deg);
            border-radius:10px;
            background:#bbd8c0;
            box-shadow:0 4px 10px rgba(0,0,0,0.1);
        }

        /* Tapa y partes del sobre — versión proporcional */
        #abrir{
            position:absolute; top:0; left:0;
            width:0; height:0;
            border-top: var(--tri-top) solid #bbd8c0;
            border-left: var(--tri-half) solid transparent;
            border-right: var(--tri-half) solid transparent;
            transform-origin:center top;
            transform-style:preserve-3d;
            z-index:10;
        }
        #partes{
            position:absolute; top:0; left:0;
            width:0; height:0;
            border-left: var(--tri-half) solid #CFE7CD;
            border-top: var(--tri-side) solid transparent;
            border-bottom: var(--tri-side) solid transparent;
            z-index:5;
        }
        #partes:after{
            content:""; position:absolute; bottom: calc(var(--tri-side) * -1); left: calc(var(--tri-half) * -1);
            width:0;height:0;
            border-bottom: var(--tri-top) solid #bbd8c0;
            border-left: var(--tri-half) solid transparent;
            border-right: var(--tri-half) solid transparent;
        }
        #partes:before{
            content:""; position:absolute; top: calc(var(--tri-side) * -1); right: calc(var(--tri-half) * -1);
            width:0;height:0;
            border-right: var(--tri-half) solid #CFE7CD;
            border-top: var(--tri-side) solid transparent;
            border-bottom: var(--tri-side) solid transparent;
        }

        /* Carta — proporcional */
        #carta{
            position:absolute;
            top:3px; left:0;
            margin-left: calc(var(--W) * 0.008); /* ≈ 5px a W=600 */
            width: var(--carta-w);
            height: var(--carta-h);
            overflow:hidden;
            z-index:1;
            border-radius:10px;
            background:#fef6f9;
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
            transition: transform 600ms cubic-bezier(.2,.9,.3,1);
        }

        .icon-cancel{
            position:absolute;
            top:8px; right:8px;
            z-index:10001;
            cursor:pointer;
            user-select:none;
            padding:6px 10px;
            border-radius:50%;
            background:rgba(255,255,255,0.85);
            color:#ff8ba7;
            transition:transform .15s, background .15s, color .15s;
            display:none;
        }
        .icon-cancel:hover{ transform:scale(1.05); color:#ff4d6d; background:rgba(255,200,220,0.95); }

        #carta img{
            display:block;
            width:100%;
            height:100%;
            object-fit:cover;
            opacity:1;
            transition: opacity 300ms ease, transform 300ms ease;
        }

        /* Animaciones sobre (transiciones iguales, desplazamientos escalados) */
        .rotar, .tapa, .rotar_, .tapa_, .bajarTop, .subirTop { transition: all 1s ease-in-out; }
        .bajarTop_, .subirTop_ { transition: all 0.8s ease-in-out; }
        .rotar_, .bajarTop, .subirTop { transition-delay: 1s; }
        .tapa, .tapa_ { transition-delay: 0.5s; }

        .rotar { transform: rotate3d(0,1,0,180deg); }
        .tapa  { transform: rotate3d(1,0,0,180deg); z-index:0 !important; }
        .rotar_ { transform: rotate3d(0,1,0,0deg); }
        .tapa_ { transform: rotate3d(1,0,0,0deg); z-index:10 !important; }

        .bajarTop{ transform: translateY(var(--up-shift)); }
        .subirTop{ transform: translateY(var(--down-shift)); }
        .bajarTop_, .subirTop_{ transform: translateY(0); }

        /* Overlay imagen (usar unidades del viewport "dinámicas" en móvil) */
        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            height: 100dvh; /* mejor en móviles modernos */
            pointer-events: none;
            z-index: 10000;
        }
        .overlay__wrapper {
            position: fixed;
            background: transparent;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.35);
            transition: top 450ms cubic-bezier(.2,.9,.3,1), left 450ms cubic-bezier(.2,.9,.3,1),
                        width 450ms cubic-bezier(.2,.9,.3,1), height 450ms cubic-bezier(.2,.9,.3,1),
                        border-radius 300ms ease;
            will-change: top,left,width,height;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.96);
        }
        .overlay__img {
            display:block;
            max-width:100%;
            max-height:100%;
            width:100%;
            height:100%;
            object-fit:contain;
            opacity:0;
            transform: translateY(18px) scale(0.99);
            transition: opacity 300ms ease, transform 300ms ease;
        }
        .overlay__img.visible { opacity:1; transform: translateY(0) scale(1); }

        .overlay__close {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10002;
            cursor: pointer;
            font-size: 18px;
            padding:6px 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.95);
            color: #ff6b91;
            user-select: none;
        }
        .overlay__close:hover { transform: scale(1.05); color: #ff4d6d; }

        /* Canvas fuegos artificiales con viewport dinámico */
        .fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            pointer-events: none;
            z-index: 10001;
        }

        /* Responsive fino para pantallas muy angostas o bajas */
        @media (max-width:360px){
            :root{ --stage-top: clamp(8px, 6vh, 24px); }
        }
        @media (max-height:520px){
            :root{ --stage-top: clamp(8px, 6vh, 24px); }
            .cara h1{ margin-top: calc(var(--H) * 0.32); }
        }
    </style>
</head>
<body>
    <div id="perspectiva">
        <div id="contenedor">
            <div class="cara frontal">
                <h1>¡ABRIME PARA DESCUBRIR OTRA RAZÓN!</h1>
            </div>

            <div class="cara trasera">
                <div id="abrir"></div>
                <div id="partes"></div>

                <div id="carta" aria-live="polite">
                    <i class="icon-cancel" role="button" aria-label="Cerrar imagen" tabindex="0">✖</i>
                    <img id="cardImage" src="tu forma de amar.png" alt="Imagen final de la carta" />
                </div>
            </div>
        </div>
    </div>

    <!-- Audios abrir/cerrar -->
    <audio id="flipSound" src="flip.mp3" preload="auto" playsinline></audio>
    <audio id="closeSound" src="close.mp3" preload="auto" playsinline></audio>

    <script>
    $(function(){
        var $contenedor = $('#contenedor'),
            $abrir = $('#abrir'),
            $carta = $('#carta'),
            $cara = $('.cara').find('h1'),
            $icon = $('.icon-cancel'),
            $pers = $('#perspectiva'),
            $img = $('#cardImage');

        var isOpen = false;
        var $overlay = null, $wrapper = null, $overlayImg = null;
        var fireworksStopper = null;

        // Sonidos
        var flipSound = document.getElementById('flipSound');
        var closeSound = document.getElementById('closeSound');

        // Desbloqueo de audio en primera interacción (móviles/desktop)
        function unlockAudioOnce() {
            var tryPlay = function(a){
                if (!a) return Promise.resolve();
                try { a.muted = true; } catch(e){}
                var p = a.play();
                if (p && p.then) {
                    return p.then(function(){ a.pause(); a.currentTime = 0; a.muted = false; });
                }
                return Promise.resolve();
            };
            Promise.all([tryPlay(flipSound), tryPlay(closeSound)]).finally(function(){
                document.removeEventListener('touchstart', unlockAudioOnce, {passive:true});
                document.removeEventListener('click', unlockAudioOnce);
            });
        }
        document.addEventListener('touchstart', unlockAudioOnce, {passive:true, once:true});
        document.addEventListener('click', unlockAudioOnce, {once:true});

        function safePlay(a){
            if (!a) return;
            try {
                a.currentTime = 0;
                var p = a.play();
                if (p && p.catch) p.catch(function(){ /* ignorar bloqueo */ });
            } catch(e){}
        }

        function calcularDimensiones(imgEl){
            var natW = imgEl.naturalWidth || imgEl.width || 800;
            var natH = imgEl.naturalHeight || imgEl.height || 600;
            var maxW = Math.round(window.innerWidth * 0.90);
            var maxH = Math.round(window.innerHeight * 0.80);
            var scale = Math.min(maxW / natW, maxH / natH, 1);
            var finalW = Math.round(natW * scale);
            var finalH = Math.round(natH * scale);
            return { w: finalW, h: finalH };
        }

        function crearOverlay(rect, imgSrc){
            $overlay = $('<div class="overlay" aria-hidden="false"></div>').appendTo('body');
            $wrapper = $('<div class="overlay__wrapper" role="dialog" aria-modal="true"></div>')
                .css({ top: rect.top + 'px', left: rect.left + 'px', width: rect.width + 'px', height: rect.height + 'px', borderRadius: '10px' })
                .appendTo($overlay);
            $overlayImg = $('<img class="overlay__img" src="'+imgSrc+'" alt="" />').appendTo($wrapper);
            var $close = $('<div class="overlay__close" role="button" tabindex="0" aria-label="Cerrar">✖</div>').appendTo($wrapper);

            $close.on('click', closeOverlay);
            $close.on('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); closeOverlay(); } });
            $overlay.on('click', function(e){ if (!$(e.target).closest('.overlay__wrapper').length) closeOverlay(); });
            $(document).on('keydown.overlay', function(e){ if (e.key === 'Escape') closeOverlay(); });

            return { $overlay, $wrapper, $img: $overlayImg };
        }

        function abrir(){
            if (isOpen) return;
            isOpen = true;

            // Sonido al girar/abrir
            safePlay(flipSound);

            $contenedor.removeClass('rotar_').addClass('rotar');
            $abrir.removeClass('tapa_').addClass('tapa');
            $carta.removeClass('bajarTop_').addClass('bajarTop');
            $pers.removeClass('subirTop_').addClass('subirTop');

            if (!$img[0].complete || ($img[0].naturalWidth === 0 && $img[0].naturalHeight === 0)) {
                $img.one('load', function(){ iniciarEmerger(); });
            } else {
                iniciarEmerger();
            }
        }

        function iniciarEmerger(){
            var rect = $carta[0].getBoundingClientRect();
            crearOverlay(rect, $img.attr('src'));
            $img.css('visibility','hidden');
            $wrapper[0].offsetHeight;
            var dims = calcularDimensiones($overlayImg[0]);
            var targetW = dims.w;
            var targetH = dims.h;
            var targetTop = Math.round((window.innerHeight - targetH) / 2);
            var targetLeft = Math.round((window.innerWidth - targetW) / 2);

            setTimeout(function(){
                $wrapper.css({ top: targetTop + 'px', left: targetLeft + 'px', width: targetW + 'px', height: targetH + 'px', borderRadius: '10px' });
                $wrapper.one('transitionend', function(ev){
                    if (ev.originalEvent && /width|height|top|left/.test(ev.originalEvent.propertyName)) {
                        $overlayImg.addClass('visible');
                        fireworksStopper = lanzarFuegosArtificiales();
                    }
                });
            }, 360);
        }

        function closeOverlay(){
            if (!isOpen) return;

            // Sonido al guardar/cerrar
            safePlay(closeSound);

            if ($overlayImg) $overlayImg.removeClass('visible');
            var rect = $carta[0].getBoundingClientRect();
            if ($wrapper) {
                $wrapper.one('transitionend', function(ev){
                    if (ev.originalEvent && /width|height|top|left/.test(ev.originalEvent.propertyName)) {
                        if ($overlay) { $overlay.remove(); $overlay = $wrapper = $overlayImg = null; }
                        $img.css('visibility','visible');
                    }
                });
                $wrapper.css({ top: Math.round(rect.top) + 'px', left: Math.round(rect.left) + 'px', width: Math.round(rect.width) + 'px', height: Math.round(rect.height) + 'px', borderRadius: '10px' });
            } else {
                $img.css('visibility','visible');
            }
            $contenedor.removeClass('rotar').addClass('rotar_');
            $abrir.removeClass('tapa').addClass('tapa_');
            $carta.removeClass('bajarTop').addClass('bajarTop_');
            $pers.removeClass('subirTop').addClass('subirTop_');
            $(document).off('keydown.overlay');
            if (fireworksStopper) { fireworksStopper(); fireworksStopper = null; }
            isOpen = false;
        }

        // Fuegos artificiales (igual)
        function lanzarFuegosArtificiales() {
            const canvas = document.createElement("canvas");
            canvas.className = "fireworks-canvas";
            document.body.appendChild(canvas);
            const ctx = canvas.getContext("2d");
            let W = canvas.width = window.innerWidth;
            let H = canvas.height = window.innerHeight;
            window.addEventListener("resize", () => { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; });
            const particles = [];
            const colors = ["#ff4d6d", "#ffcc00", "#00ccff", "#66ff66", "#ff66ff", "#ff9966"];
            function random(min, max) { return Math.random() * (max - min) + min; }
            function createFirework() {
                const x = random(W * 0.2, W * 0.8);
                const y = random(H * 0.1, H * 0.4);
                const count = random(40, 70);
                for (let i = 0; i < count; i++) {
                    const angle = (Math.PI * 2 * i) / count;
                    const speed = random(2, 6);
                    particles.push({ x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, alpha: 1, color: colors[Math.floor(Math.random() * colors.length)], radius: random(2, 4) });
                }
            }
            let frame;
            function animate() {
                ctx.clearRect(0, 0, W, H);
                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.05;
                    p.alpha -= 0.01;
                    if (p.alpha <= 0) { particles.splice(i, 1); continue; }
                    ctx.globalAlpha = p.alpha;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                }
                ctx.globalAlpha = 1;
                frame = requestAnimationFrame(animate);
            }
            const interval = setInterval(createFirework, 800);
            createFirework();
            animate();
            return function stop() { clearInterval(interval); cancelAnimationFrame(frame); canvas.remove(); };
        }

        // eventos
        setTimeout(function(){ abrir(); }, 1500);
        $cara.on('click', function(e){ e.preventDefault(); abrir(); });
        $icon.on('click', function(e){ e.preventDefault(); closeOverlay(); });
        $icon.on('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); closeOverlay(); } });
        $carta.on('click', function(e){ e.stopPropagation(); });
        $img.on('load', function(){ if (isOpen && !$overlay) iniciarEmerger(); });
        $(window).on('resize', function(){
            if (!$overlay || !$wrapper || !$overlayImg) return;
            var dims = calcularDimensiones($overlayImg[0]);
            var targetW = dims.w, targetH = dims.h;
            var targetTop = Math.round((window.innerHeight - targetH) / 2);
            var targetLeft = Math.round((window.innerWidth - targetW) / 2);
            $wrapper.css({ top: targetTop + 'px', left: targetLeft + 'px', width: targetW + 'px', height: targetH + 'px' });
        });
    });
    </script>
</body>
</html>

